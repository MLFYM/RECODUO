# :hourglass_flowing_sand:모델링

> 데이터 전처리를 끝낸 dataset이 준비되었다면, 그 다음은 훈련시킬 모델을 정할 차례다. 얼굴 이미지 데이터를 활용하기에 Convolution Neural Network, 약칭 CNN 기반의 모델들을 시험했으며, 이러한 과정을 결과로 최종 모델을 선정하였다. 

![Example-CNN-architecture](https://user-images.githubusercontent.com/58945760/88549724-a1994800-d05b-11ea-9d49-73f884a88302.png)



 이하의 과정은 `django`을 통한 웹 서비스 개발, 데이터 전처리와 병행하여 진행되었으며, 모델링을 한 후에는 실제 웹페이지에서 `test`를 진행하였다.  



## 1. 전이학습(Transfer learning)

![1_1CxVzTNILTHgDs5yJO4W9A](https://user-images.githubusercontent.com/58945760/88550116-1ec4bd00-d05c-11ea-964f-6e868ef8f008.png)



**Deep Neural Network**와 **Convolution Neural Network**를 기반으로 한 모델링은 크게 두 가지로 나뉜다. 

 첫 번째는 Layer를 한 층 한 층 쌓아올려 자체적인 모델을 만드는 것이다. 보통 처음 모델링을 하고 개념을 이해할 때는 이 방법을 사용한다. 그러나 코드를 계속 돌려보며 하이퍼 파라미터를 조정하여야 하기에 최적을 모델을 찾는 데 시간이 오래 걸린다는 단점이 있다. 훈련할 데이터 양과 분류할 항목이 많아질 시 이 단점은 더욱 심화된다.  

 그렇기에 두 번째 방법으로 미리 훈련시켜놓은 모델을 불러와 사용하는 방법을 사용하는 경우가 많다. keras에는 이미 `imagenet`이라는 거대한 dataset으로 훈련시켜 놓은 많은 모델들이 존재한다. keras 내에서 `import` 하기만 하면 그 모델들을 자유롭게 사용할 수 있다.  

  

### 1.1 모델 후보 선정

> 공식 [keras API 문서](https://keras.io/api/applications/)에 존재하는 전이학습 모델들만 27개가 존재한다. 우리는 먼저 모델들의 성능을 비교할 수 있는 간단한 dataset을 만들어 시험해보기로 하였다. 

우선은 다른 Positive, Neutral에 해당하는 데이터를 각각 2,000장씩 모아 dataset을 구성하였다. 그리고 keras API에 들어 있는 모델을 모두 사용하여 데이터의 감정을 분류하는 실험을 진행했다. 결과적으로 0.76~1.00에 해당하는 정확도를 낼 수 있었다. 

우리는 그 중에서 가장 높은 정확도를 보인 모델은 `DenseNet`, `MoblieNet`, `Xception`이었다. 이 모델들을 대상으로 결과를 비교하여 분류 모델로 활용하기로 하였다. 



### 1.2  모델 시험하기

여러 모델 중 높은 정확도를 보여준 모델들은 다음과 같다.

|   Model   | Accuracy | Loss  |
| :-------: | :------: | :---: |
| Xception  |  0.998   | 0.001 |
|  ResNet   |  0.998   | 0.003 |
| DenseNet  |  0.991   | 0.037 |
| MobileNet |  0.890   | 1.391 |
|    ...    |   ...    |  ...  |

위의 결과에서 보이듯이, `validation set` 기준으로 평균 95% 이상의 높은 정확도를 확보할 수 있었다. 하지만 `jupyter notebook`에서의 모델 정확도와는 별개로, 웹페이지에 모델을 적용하는 과정에서 여러가지 문제가 발생했다. 



### 1.3 웹페이지 모델 적용, 문제점 개선

#### 1.3.1 모델 `load` 시간 단축

 웹페이지에 모델을 적용시키는 데 문제가 발생하였다. 웹캠으로 받아들인 사진의 감정을 분류할 때마다 모델 `loading`에 40초~1분 이상의 긴 시간이 필요했던 것이다. 우리가 시험해본 모델들은 모두 CNN을 기반으로 하고 있었으며, 그에 따라 용량이 큰 편이었기에 자연스러운 일이라고 할 수 있었다. 하지만 웹 서비스 개발에 있어서는 반드시 개선해야 할 점이었다. 

다행히 `MobileNet`의 경우, `h5`파일의 용량이 다른 모델의 절반임에도 정확도에 있어 다른 후보 모델과 큰 차이를 보이지 않았기에 `loading` 시간을 10초~20초, 약 절반 가량 이상으로 줄일 수 있었다. 그러나 이것만으로도 빠른 서비스에 익숙한 사용자에게 제공하기에는 무리가 있다고 판단하였고, 감정 분류를 할 때마다 계속 모델을 불러오는 번거로움을 해결할 수 있는 보다 근본적인 해결책이 필요했다. 

그러던 중, `tf.get_default_graph`로 `runserver` 실행과 함께 모델을 미리 `load`하여, input된 사진의 감정 분류 시마다 모델을 `load`하는 반복적인 연산이 발생하지 않도록 하였다. 그 결과 감정 분류 결과를 1초~2초 내에 볼 수 있도록 할 수 있었고, 추천 시스템 등 다른 서비스 구현을 계속 진행할 수 있었다. 



#### 1.3.2 과적합(Overfitting) 해결

 또 다른 문제이자 가장 큰 문제는, 모델의 분류 결과가 **지나친 편중 현상**을 보인다는 점이었다. 

예를 들어, 기쁨 30장, 무표정 40장, 찡그림 30장을 합쳐 **100장**의 얼굴 사진을 모델에 input했을 때, 나오는 결과 중 **70장**이 찡그림으로 분류되는 상황인 것이다. 이러한 문제는 다른 전이학습 모델에서도 동일하게 발생하였다. 

이는 심각한 문제였다. 하이퍼 파라미터를 튜닝한 모델 정확도가 아무리 높다 해도 실제 데이터를 input하였을 때 그 정확도가 반영되지 않는다면 아무 의미가 없었다. 이러한 결과의 원인을 찾는 것이 무엇보다도 급선무라 판단되었다. 



#### 데이터 추가

![데이터 추가](https://user-images.githubusercontent.com/58945760/89427140-e026b500-d775-11ea-9a15-8f4246caa091.PNG)

처음에는 모델의 문제라 생각하여 후보군에 있었던 다른 모델들로 시도해보았으나 결과 편중 현상은 똑같이 발생하였다.  동결층을 조절하고, 하이퍼파라미터를 튜닝하여도 마찬가지였다. 

혹시나 데이터에 문제가 있는 것인가 하는 의문을 가지고 데이터를 다시 살펴본 결과, 이러한 편중 현상의 원인을 짐작해볼 수 있었다. 주 dataset으로 사용한 K-FACE dataset의 경우, **35,000 장이 넘는 데이터 수에 비해 해당 데이터셋 구축에 참여한 사람은 1,000명뿐이었다**. 따라서 이미지 속의 인물이 겹치는 경우가 많았으며, **데이터들 간의 유사도가 높을 수밖에 없어 과적합이 생길 위험이 그만큼 높았던 것이다**.  

이 문제를 해결하기 위해 Sub dataset이었던 FFHQ dataset에서 Positive, Neutral 데이터를 추가하였다. Negative의 데이터를 따로 추가하지 않은 이유는, 편중 현상이 Negative로 집중된 것을 보았을 때 그 특성 추출이 다른 두 감정에 비해 용이할 것이라 판단하였기 때문이다. 또한 이러한 데이터 추가를 통해 결과 편중 현상을 해결할 수 있는지를 보다 신속히 확인하기 위해서이기도 했다. 

우선 500장부터 5,000장까지의 데이터를 각각 준비하여 실험해본 결과 500장~2,000장을 추가하였을 때 편중 현상이 완화되었고, 2,000장을 추가하였을 때 가장 결과가 좋았으므로 전체 데이터 수를 40,088장으로 최종 확정하였다.

  

### 1.4 다른 모델과의 비교 및 결론

#### 1.4.1. dlib을 활용한 DNN 모델

![dnn 모델링](https://user-images.githubusercontent.com/58945760/92468980-06c18b00-f20f-11ea-8514-0bfd6940cf41.PNG)

과적합을 해결하기 위한 또다른 방법으로 `dlib`라이브러리를 통한 DNN 모델링도 시도하였고 88%의 정확도를 얻을 수 있었다.  그러나 결과 편중 현상을 해결할 수는 없었기에 실제 모델로 사용하지는 않았다. 

 

## 2. 최종 CNN 모델

> 위의 실험을 거쳐 결정한 최종 모델이다.

![모델링](https://user-images.githubusercontent.com/58945760/90897416-0d26c900-e400-11ea-9e12-f8195f3eacaa.PNG)



- **f1 score** 

![great score](https://user-images.githubusercontent.com/58945760/89898306-6ed67e80-dc1b-11ea-92d0-d5e5d3cf2aae.PNG)

- Accuracy, loss 변화 그래프

![데이터 2차 추가 후 graph](https://user-images.githubusercontent.com/58945760/89898248-56666400-dc1b-11ea-86e2-641e30628d75.PNG)

